<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Exercise 0x7 - HTML5--Canvas、SVG</title>
  <style>
    body {
      margin: 0px;
      padding: 0px;
    }
    #content{
      padding: 5px;
      width: 1000px;
      height: 550px;
      margin: 20px auto;
    }
    #toolbox{
      float :left;
      border: 1px solid #000000;
      width: 15%;
    }
    #Sketchpad {
      float: left;
      border: 1px solid #9C9898;
    }
  </style>
  <script type="text/javascript" src="http://jaysonhwang-static.stor.sinaapp.com/js/jquery.js"></script>
</head>
<body>
  <div id="content">
    <canvas id="Sketchpad" width="700px" height="500px"></canvas>
    <div id="toolbox">
      <input type="button" id="pen" value="画笔" onclick="ontoolchange(this)"/><br />
      <input type="button" id="line" value="直线" onclick="ontoolchange(this)"/><br />
      <input type="button" id="circle" value="圆" onclick="ontoolchange(this)"/><br />
      <br />
      <input type="button" value="清空画板" onclick="onclear()"><br />
      <hr /><span id="coordinate"></span><hr />
      <span id="cur_tool">当前工具:<strong>画笔</strong></span><br/>
      <hr /><span id="status">拖动鼠标以绘制</span><hr />
      <br />
      <form id="line_form">
        第一个点:<br />(<input id="first_x" size="3" />,<input id="first_y" size="3" />)<br />
        第二个点:<br />(<input id="second_x" size="3" />,<input id="second_y" size="3" />)<br />
        <input type="button" value="绘制" onclick="ondrawline(this)" />
      </form>
      <form id="circle_form">
        圆心:<br />(<input id="circle_x" size="3" />,<input id="circle_y" size="3" />)<br />
        半径:<input id="circle_r" size="3" /><br />
        <input type="button" value="绘制" onclick="ondrawcircle(this)" />
      </form>
    </div>
  </div>

  <script type="text/javascript">
    function Sketchpad(canvas_id, line_form_id, circle_form_id, coordinate_id){
      var canvas, context;
      var isPainting;
      var offset;

      var Xpath = [], Ypath = [], drag = [];
      var lines = [];
      var circles = [];

      var cur_tool;
      var line_form, circle_form;
      var coordinate_span;
      var stroke = null;

      var init=function(){
        line_form = document.getElementById(line_form_id);
        circle_form = document.getElementById(circle_form_id);
        coordinate_span = document.getElementById(coordinate_id)

        coordinate_span.innerHTML = '坐标:(?,?)';
        canvas = document.getElementById(canvas_id);
        context = canvas.getContext("2d");
        isPainting = false;
        offset = {
          'top': canvas.offsetTop,
          'left': canvas.offsetLeft,
        }
        // console.log(offset['top'],offset['left']);
        

        canvas.onmousedown = function(e){
          switch (cur_tool){
            case 0:
              isPainting = true;
              var x=e.pageX, y=e.pageY;
              recordClick(x,y, false);
              flush();
              break;
          }
        }
        canvas.onmouseup = function(e){
          switch (cur_tool){
            case 0:
              isPainting = false;
              flush();
              break;
          }
        }
        canvas.onmousemove = function(e){
          coordinate_span.innerHTML = '坐标:('+(e.pageX-offset['left'])+','+(e.pageY-offset['top'])+')';
          switch (cur_tool){
            case 0:
              if(isPainting){
                var x=e.pageX, y=e.pageY;
                recordClick(x,y, true);
                flush();
              }
              break;
          }
        }
        canvas.onmouseout = function(e){
          switch (cur_tool){
            case 0:
              isPainting = false;
              break;
          }
        }
      }

      this.changetool = function(type){
        cur_tool = type;
        switch(type){
          case Sketchpad.TYPE_PEN:
            line_form.style.display='none';
            circle_form.style.display='none';
            break;
          case Sketchpad.TYPE_LINE:
            line_form.style.display='block';
            circle_form.style.display='none';
            break;
          case Sketchpad.TYPE_CIRCLE:
            line_form.style.display='none';
            circle_form.style.display='block';
            break;
        }
      }

      this.clear = function(){
        Xpath = [];Ypath = []; drag = [];
        flush();
      }

      var drawLine = function(line){
        context.beginPath();
        context.strokeStyle = '#ff0000';
        context.moveTo(line['first']['x'], line['first']['y']);
        context.lineTo(line['second']['x'], line['second']['y']);
        context.stroke();
      }
      this.addLine = function(line){
        lines.push(line);
        drawLine(line);
      }

      var drawCircle = function(circle){
        context.beginPath();
        context.strokeStyle = '#0000ff';
        context.arc(circle['center']['x'],circle['center']['y'],
                    circle['r'],
                    0,Math.PI*2,true);
        context.stroke();
      }
      this.addCircle = function(circle){
        circles.push(circle);
        drawCircle(circle);
      }

      this.defaultGraph = function(){
        //画直线
        var line = {
          'first':{'x':50, 'y':50} ,
          'second':{'x':300, 'y':150} ,
        }
        drawLine(line)
        //画圆
        var circle = {
          'center':{'x':350, 'y':350} ,
          'r':100,
        }
        drawCircle(circle);
        //画矩形
        context.beginPath();
        context.strokeStyle = "#00ff00";
        context.rect(100,100,350,150);
        context.stroke();
      }

      //重绘
      var flush = function(){
        context.clearRect (0 , 0, canvas.width , canvas.height);
        context.strokeStyle = "#000000";
        for(var i=0; i<Xpath.length; ++i){
          context.beginPath();
          if(drag[i]){
            context.moveTo(Xpath[i-1], Ypath[i-1]);
            context.lineTo(Xpath[i], Ypath[i]);
          }else{
            context.arc(Xpath[i], Ypath[i], 0.5, 0, 2*Math.PI, true);
          }
          context.closePath();
          context.stroke();
        }
        for(var i=0; i<lines.length; ++i){
          drawLine(lines[i]);
        }
        for(var i=0; i<circles.length; ++i){
          drawCircle(circles[i]);
        }
      }

      function recordClick(x,y,isDragging){
        Xpath.push(x-offset['left']);Ypath.push(y-offset['top']);
        drag.push(isDragging);
        // console.log(x+','+y+','+isDragging);
      }

      // 调用构造函数
      init();
      this.defaultGraph();
      this.changetool(Sketchpad.TYPE_PEN);
      
    }
    Sketchpad.TYPE_PEN = 0;
    Sketchpad.TYPE_LINE = 1;
    Sketchpad.TYPE_CIRCLE = 2;




    var sketchpad;
    window.onload = function (argument) {
      sketchpad = new Sketchpad('Sketchpad', 'line_form', 'circle_form', 'coordinate');
    }
    
    function ontoolchange(elem){
      console.log(elem.id,elem.value);
      var cur_tool = document.getElementById('cur_tool');
      var status = document.getElementById('status');
      switch(elem.id){
        case 'pen':
          sketchpad.changetool(Sketchpad.TYPE_PEN);
          status.innerHTML = '拖动鼠标以绘制';
          break;
        case 'line':
          sketchpad.changetool(Sketchpad.TYPE_LINE);
          status.innerHTML = '在下面输入直线的起点和终点坐标后按“绘制”进行绘制';
          break;
        case 'circle':
          sketchpad.changetool(Sketchpad.TYPE_CIRCLE);
          status.innerHTML = '在下面输入圆心坐标和半径后按“绘制”进行绘制';
          break;
      }
      cur_tool.innerHTML='当前工具:<strong>'+elem.value+'</strong>';
    }

    function onclear(){
      sketchpad.clear();
    }

    function ondrawline(form){
      var line = {
        'first':{'x':$('#first_x').val(), 'y':$('#first_y').val(),} ,
        'second':{'x':$('#second_x').val(), 'y':$('#second_y').val()} ,
      }
      console.log('line',line);
      sketchpad.addLine(line);
    }

    function ondrawcircle(form){
      var circle = {
        'center' : {'x':$('#circle_x').val(), 'y':$('#circle_y').val(),},
        'r' : $('#circle_r').val(),
      }
      console.log('circle',circle);
      sketchpad.addCircle(circle);
    }
    
  </script>
  
</body>
</html>
